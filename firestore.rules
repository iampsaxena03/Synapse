rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---
    function isAuthenticated() {
      return request.auth != null;
    }

    function isDirectChatParticipant(chatId) {
      return chatId.split('_').hasAny([request.auth.uid]);
    }

    // --- LOGIC: MARK AS READ ---
    function isMarkAsRead() {
      return request.resource.data.content == resource.data.content &&
             request.resource.data.senderId == resource.data.senderId &&
             request.resource.data.type == resource.data.type &&
             request.resource.data.read == true;
    }

    // --- LOGIC: DELETE FOR ME ---
    function isDeleteForMe() {
      let existingDeleted = resource.data.get('deletedFor', []);
      let newDeleted = request.resource.data.get('deletedFor', []);
      
      // Ensure content remains unchanged
      let contentUnchanged = request.resource.data.content == resource.data.content;
      
      return contentUnchanged &&
             newDeleted.size() == existingDeleted.size() + 1 &&
             newDeleted.hasAll(existingDeleted) &&
             newDeleted[newDeleted.size() - 1] == request.auth.uid;
    }

    // --- LOGIC: DELETE FOR EVERYONE ---
    function isDeleteForEveryone() {
      return resource.data.senderId == request.auth.uid &&
             request.resource.data.isDeleted == true &&
             (request.resource.data.content == '' || request.resource.data.content == null) &&
             request.resource.data.type == 'deleted';
    }

    // --- LOGIC: EDIT MESSAGE ---
    function isEditMessage() {
      return resource.data.senderId == request.auth.uid &&
             request.resource.data.isEdited == true &&
             request.resource.data.diff(resource.data).affectedKeys().hasOnly(['content', 'isEdited', 'editedAt']);
    }

    // --- 1. SETTINGS (REQUIRED FOR ADMIN LOGIN) ---
    match /settings/admin_access {
      allow read: if true; 
      allow write: if false; 
    }

    // --- 2. USERS (UPDATED FOR ADMIN DELETE) ---
    match /users/{userId} {
      allow read: if true;
      
      // ALLOW WRITE IF:
      // 1. User is editing themselves
      // 2. OR The Admin (logged in Anonymously) is performing an action (like DELETE/BAN)
      allow write: if (isAuthenticated() && request.auth.uid == userId) || 
                      (request.auth.token.firebase.sign_in_provider == 'anonymous');

      match /activeChats/{partnerId} {
        allow read: if isAuthenticated() && request.auth.uid == userId;
        allow write: if isAuthenticated() && (
          request.auth.uid == userId || 
          request.auth.uid == partnerId
        );
      }
      
      match /clubStates/{clubId} {
        allow read, write: if isAuthenticated() && request.auth.uid == userId;
      }
    }

    // --- 3. DIRECT CHATS ---
    match /chats/{chatId} {
      allow read: if isAuthenticated() && isDirectChatParticipant(chatId);

      match /messages/{msgId} {
        allow read: if isAuthenticated() && isDirectChatParticipant(chatId);
        
        allow create: if isAuthenticated() && 
                         isDirectChatParticipant(chatId) && 
                         request.resource.data.senderId == request.auth.uid;
        
        allow update: if isAuthenticated() && isDirectChatParticipant(chatId) && (
          isMarkAsRead() || isDeleteForMe() || isDeleteForEveryone() || isEditMessage()
        );
      }

      match /typing/{userId} {
        allow read: if isAuthenticated() && isDirectChatParticipant(chatId);
        allow write: if isAuthenticated() && isDirectChatParticipant(chatId) && request.auth.uid == userId;
      }
    }

    // --- 4. CLUBS ---
    match /clubs/{clubId} {
      allow read: if isAuthenticated();
      allow update: if isAuthenticated(); 
      
      match /messages/{msgId} {
        allow read: if isAuthenticated();
        
        allow create: if isAuthenticated() && 
                         request.resource.data.senderId == request.auth.uid;
        
        allow update: if isAuthenticated() && (
          isDeleteForMe() || isDeleteForEveryone() || isEditMessage()
        );
      }

      match /typing/{userId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated() && request.auth.uid == userId;
      }
    }
  }
}