rules_version = '2';

service cloud.firestore {
match /databases/{database}/documents {

// --- USER RULES ---
match /users/{userId} {
  allow read, write: if request.auth != null && request.auth.uid == userId;
  // Allow searching users (reading other profiles)
  allow read: if request.auth != null; 
  
  match /activeChats/{chatId} {
    allow read, write: if request.auth != null && request.auth.uid == userId;
  }
  match /clubStates/{clubId} {
    allow read, write: if request.auth != null && request.auth.uid == userId;
  }
}

// --- CHAT MESSAGES RULES ---
match /chats/{chatId}/messages/{msgId} {
  allow read: if request.auth != null;
  
  // CREATE: Allow if senderId matches user's UID
  allow create: if request.auth != null && request.resource.data.senderId == request.auth.uid;
  
  // UPDATE: Specialized Rule for Soft Delete / Edit
  allow update: if request.auth.uid == resource.data.senderId
                && isPermittedUpdate();
                
  function isPermittedUpdate() {
    // Only allow changing 'isDeleted' and 'content' (for clearing text)
    // Prevents tampering with timestamp or senderId
    return (request.resource.data.keys().hasOnly(['isDeleted', 'content', 'read', 'type', 'senderId', 'timestamp', 'displayName']) &&
            request.resource.data.diff(resource.data).affectedKeys().hasAny(['isDeleted', 'content', 'read']));
  }
}

// --- TYPING INDICATORS ---
match /chats/{chatId}/typing/{userId} {
  allow read, write: if request.auth != null;
}

// --- CLUBS RULES (Simplified for now) ---
match /clubs/{clubId} {
  allow read: if request.auth != null;
  match /messages/{msgId} {
    allow read, create: if request.auth != null;
    allow update: if request.auth.uid == resource.data.senderId;
  }
  match /typing/{userId} {
    allow read, write: if request.auth != null;
  }
}


}
}